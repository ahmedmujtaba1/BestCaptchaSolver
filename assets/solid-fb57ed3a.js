const R=(t,e)=>t===e,y={equals:R};let U=T;const h=1,d=2,M={owned:null,cleanups:null,context:null,owner:null};var c=null;let k=null,o=null,i=null,f=null,m=0;function V(t,e){const n=o,s=c,u=t.length===0,r=u?M:{owned:null,cleanups:null,context:null,owner:e===void 0?s:e},l=u?t:()=>t(()=>a(()=>E(r)));c=r,o=null;try{return b(l,!0)}finally{o=n,c=s}}function W(t,e){e=e?Object.assign({},y,e):y;const n={value:t,observers:null,observerSlots:null,comparator:e.equals||void 0},s=u=>(typeof u=="function"&&(u=u(n.value)),O(n,u));return[N.bind(n),s]}function $(t,e,n){const s=C(t,e,!1,h);g(s)}function j(t,e,n){U=P;const s=C(t,e,!1,h);s.user=!0,f?f.push(s):g(s)}function p(t,e,n){n=n?Object.assign({},y,n):y;const s=C(t,e,!0,0);return s.observers=null,s.observerSlots=null,s.comparator=n.equals||void 0,g(s),N.bind(s)}function a(t){if(o===null)return t();const e=o;o=null;try{return t()}finally{o=e}}function z(t){j(()=>a(t))}function q(t){const e=p(t),n=p(()=>x(e()));return n.toArray=()=>{const s=n();return Array.isArray(s)?s:s!=null?[s]:[]},n}function N(){if(this.sources&&this.state)if(this.state===h)g(this);else{const t=i;i=null,b(()=>A(this),!1),i=t}if(o){const t=this.observers?this.observers.length:0;o.sources?(o.sources.push(this),o.sourceSlots.push(t)):(o.sources=[this],o.sourceSlots=[t]),this.observers?(this.observers.push(o),this.observerSlots.push(o.sources.length-1)):(this.observers=[o],this.observerSlots=[o.sources.length-1])}return this.value}function O(t,e,n){let s=t.value;return(!t.comparator||!t.comparator(s,e))&&(t.value=e,t.observers&&t.observers.length&&b(()=>{for(let u=0;u<t.observers.length;u+=1){const r=t.observers[u],l=k&&k.running;l&&k.disposed.has(r),(l?!r.tState:!r.state)&&(r.pure?i.push(r):f.push(r),r.observers&&D(r)),l||(r.state=h)}if(i.length>1e6)throw i=[],new Error},!1)),e}function g(t){if(!t.fn)return;E(t);const e=c,n=o,s=m;o=c=t,G(t,t.value,s),o=n,c=e}function G(t,e,n){let s;try{s=t.fn(e)}catch(u){return t.pure&&(t.state=h,t.owned&&t.owned.forEach(E),t.owned=null),t.updatedAt=n+1,F(u)}(!t.updatedAt||t.updatedAt<=n)&&(t.updatedAt!=null&&"observers"in t?O(t,s):t.value=s,t.updatedAt=n)}function C(t,e,n,s=h,u){const r={fn:t,state:s,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:c,context:null,pure:n};return c===null||c!==M&&(c.owned?c.owned.push(r):c.owned=[r]),r}function S(t){if(t.state===0)return;if(t.state===d)return A(t);if(t.suspense&&a(t.suspense.inFallback))return t.suspense.effects.push(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<m);)t.state&&e.push(t);for(let n=e.length-1;n>=0;n--)if(t=e[n],t.state===h)g(t);else if(t.state===d){const s=i;i=null,b(()=>A(t,e[0]),!1),i=s}}function b(t,e){if(i)return t();let n=!1;e||(i=[]),f?n=!0:f=[],m++;try{const s=t();return I(n),s}catch(s){n||(f=null),i=null,F(s)}}function I(t){if(i&&(T(i),i=null),t)return;const e=f;f=null,e.length&&b(()=>U(e),!1)}function T(t){for(let e=0;e<t.length;e++)S(t[e])}function P(t){let e,n=0;for(e=0;e<t.length;e++){const s=t[e];s.user?t[n++]=s:S(s)}for(e=0;e<n;e++)S(t[e])}function A(t,e){t.state=0;for(let n=0;n<t.sources.length;n+=1){const s=t.sources[n];if(s.sources){const u=s.state;u===h?s!==e&&(!s.updatedAt||s.updatedAt<m)&&S(s):u===d&&A(s,e)}}}function D(t){for(let e=0;e<t.observers.length;e+=1){const n=t.observers[e];n.state||(n.state=d,n.pure?i.push(n):f.push(n),n.observers&&D(n))}}function E(t){let e;if(t.sources)for(;t.sources.length;){const n=t.sources.pop(),s=t.sourceSlots.pop(),u=n.observers;if(u&&u.length){const r=u.pop(),l=n.observerSlots.pop();s<u.length&&(r.sourceSlots[l]=s,u[s]=r,n.observerSlots[s]=l)}}if(t.owned){for(e=t.owned.length-1;e>=0;e--)E(t.owned[e]);t.owned=null}if(t.cleanups){for(e=t.cleanups.length-1;e>=0;e--)t.cleanups[e]();t.cleanups=null}t.state=0,t.context=null}function F(t){throw t}function x(t){if(typeof t=="function"&&!t.length)return x(t());if(Array.isArray(t)){const e=[];for(let n=0;n<t.length;n++){const s=x(t[n]);Array.isArray(s)?e.push.apply(e,s):e.push(s)}return e}return t}function B(t,e){return a(()=>t(e||{}))}const L=t=>`Stale read from <${t}>.`;function H(t){const e=t.keyed,n=p(()=>t.when,void 0,{equals:(s,u)=>e?s===u:!s==!u});return p(()=>{const s=n();if(s){const u=t.children;return typeof u=="function"&&u.length>0?a(()=>u(e?s:()=>{if(!a(n))throw L("Show");return t.when})):u}return t.fallback},void 0,void 0)}function J(t){let e=!1;const n=(r,l)=>r[0]===l[0]&&(e?r[1]===l[1]:!r[1]==!l[1])&&r[2]===l[2],s=q(()=>t.children),u=p(()=>{let r=s();Array.isArray(r)||(r=[r]);for(let l=0;l<r.length;l++){const w=r[l].when;if(w)return e=!!r[l].keyed,[l,w,r[l]]}return[-1]},void 0,{equals:n});return p(()=>{const[r,l,w]=u();if(r<0)return t.fallback;const v=w.children;return typeof v=="function"&&v.length>0?a(()=>v(e?l:()=>{if(a(u)[0]!==r)throw L("Match");return w.when})):v},void 0,void 0)}function K(t){return t}export{K as M,H as S,V as a,$ as b,W as c,B as d,p as e,J as f,z as o,a as u};
